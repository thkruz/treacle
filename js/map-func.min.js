var map,lastLat,lastLng,lastMarker,touchPos,HEADING_LINE_DISTANCE=5e4,DEBUG_MODE=!1,isFollowGps=!1,forceGPS=!1,heatmapRadius=300,heatmapIntensity=10,heatMapData=[],antMapData=[],headingLineData=[],saveData=[],isMoving=!1;function initMap(){DEBUG_MODE&&console.log(`${Date.now()}: initMap()`),M.AutoInit();M.Dropdown.init(document.getElementById("rightClickTrigger-map"),{constrainWidth:!1}),M.Dropdown.init(document.getElementById("rightClickTrigger-ant"),{constrainWidth:!1});var e=JSON.parse(localStorage.getItem("lastZoom"));null==e&&(e=16);var t=JSON.parse(localStorage.getItem("lastLoc"));null==t&&(t={lat:42.184467,lng:-70.929094}),null==(heatmapRadius=JSON.parse(localStorage.getItem("heatmapRadius")))&&(heatmapRadius=300),null==(heatmapIntensity=JSON.parse(localStorage.getItem("heatmapIntensity")))&&(heatmapIntensity=10),document.addEventListener("contextmenu",e=>e.preventDefault()),map=new google.maps.Map(document.getElementById("map"),{center:t,mapTypeId:"terrain",styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]},{elementType:"geometry",stylers:[{color:"#ebe3cd"}]},{elementType:"labels",stylers:[{visibility:"off"}]},{elementType:"labels.text.fill",stylers:[{color:"#523735"}]},{elementType:"labels.text.stroke",stylers:[{color:"#f5f1e6"}]},{featureType:"administrative",elementType:"geometry",stylers:[{color:"#c9b2a6"}]},{featureType:"landscape.natural",elementType:"geometry",stylers:[{color:"#dfd2ae"}]},{featureType:"poi",elementType:"labels.text.fill",stylers:[{color:"#93817c"}]},{featureType:"poi.park",elementType:"geometry.fill",stylers:[{color:"#a5b076"}]},{featureType:"poi.park",elementType:"labels.text.fill",stylers:[{color:"#447530"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#f5f1e6"}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{color:"#fdfcf8"}]},{featureType:"road.highway",elementType:"geometry",stylers:[{color:"#f8c967"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#e9bc62"}]},{featureType:"road.highway.controlled_access",elementType:"geometry",stylers:[{color:"#e98d58"}]},{featureType:"road.highway.controlled_access",elementType:"geometry.stroke",stylers:[{color:"#db8555"}]},{featureType:"road.local",elementType:"labels.text.fill",stylers:[{color:"#806b63"}]},{featureType:"transit.line",elementType:"geometry",stylers:[{color:"#dfd2ae"}]},{featureType:"transit.line",elementType:"labels.text.fill",stylers:[{color:"#8f7d77"}]},{featureType:"transit.line",elementType:"labels.text.stroke",stylers:[{color:"#ebe3cd"}]},{featureType:"transit.station",elementType:"geometry",stylers:[{color:"#dfd2ae"}]},{featureType:"water",elementType:"geometry.fill",stylers:[{color:"#b9d3c2"}]},{featureType:"water",elementType:"labels.text.fill",stylers:[{color:"#92998d"}]}],streetViewControl:!1,mapTypeControl:!1,fullscreenControl:!1,zoom:e,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}}),window.screen.width<800?(map.addListener("click",function(e){DEBUG_MODE&&console.log(`${Date.now()}: map.addListener('click', function(e)`),DEBUG_MODE&&console.log(e),lastLat=e.latLng.lat(),lastLng=e.latLng.lng()}),document.body.addEventListener("touchstart",function(e){DEBUG_MODE&&console.log(`${Date.now()}: document.body.addEventListener('touchstart', function(e)`),DEBUG_MODE&&console.log(e),touchPos=e}),document.body.addEventListener("touchend",function(e){if(DEBUG_MODE&&console.log(`${Date.now()}: document.body.addEventListener('touchend', function (e)`),DEBUG_MODE&&console.log(e),console.log(isMoving),"div"==e.target.localName&&!isMoving){dropdownMenus=document.querySelectorAll(".dropdown-trigger");for(var t=0;t<dropdownMenus.length;t++)M.Dropdown.getInstance(dropdownMenus[t]).close();M.Dropdown.getInstance(document.getElementById("rightClickTrigger-map")).open();var a=document.getElementById("rightClickMenu-map");touchPos.touches[0].clientX<window.screen.width/2?a.style.left=`${touchPos.touches[0].clientX}px`:a.style.left=`${touchPos.touches[0].clientX-document.getElementById("rightClickMenu-map").offsetWidth}px`,touchPos.touches[0].clientY<window.screen.height/2?a.style.top=`${touchPos.touches[0].clientY}px`:a.style.top=`${touchPos.touches[0].clientY-document.getElementById("rightClickMenu-map").offsetHeight}px`}})):map.addListener("rightclick",function(e){DEBUG_MODE&&console.log(`${Date.now()}: map.addListener('rightclick', function(e)`),DEBUG_MODE&&console.log(e),dropdownMenus=document.querySelectorAll(".dropdown-trigger");for(var t=0;t<dropdownMenus.length;t++)M.Dropdown.getInstance(dropdownMenus[t]).close();M.Dropdown.getInstance(document.getElementById("rightClickTrigger-map")).open();var a=document.getElementById("rightClickMenu-map");e.tb.clientX<window.screen.width/2?a.style.left=`${e.tb.clientX}px`:a.style.left=`${e.tb.clientX-document.getElementById("rightClickMenu-map").offsetWidth}px`,e.tb.clientY<window.screen.height/2?a.style.top=`${e.tb.clientY}px`:a.style.top=`${e.tb.clientY-document.getElementById("rightClickMenu-map").offsetHeight}px`,lastLat=e.latLng.lat(),lastLng=e.latLng.lng()}),map.addListener("center_changed",function(e){forceGPS||(isFollowGps=!1,document.getElementById("gpsBtn").innerHTML='<i class="large material-icons">gps_off</i>'),localStorage.setItem("lastLoc",JSON.stringify({lat:map.center.lat(),lng:map.center.lng()})),isMoving=!0,setTimeout(function(){isMoving=!1},1e3)}),map.addListener("zoom_changed",function(e){localStorage.setItem("lastZoom",JSON.stringify(map.zoom))});var a=document.createElement("div"),n=(new IncreaseRadiusControl(a,map),document.createElement("div"));new DecreaseRadiusControl(n,map);a.index=1,n.index=1,map.controls[google.maps.ControlPosition.LEFT_CENTER].push(a),map.controls[google.maps.ControlPosition.LEFT_CENTER].push(n);var o=document.createElement("div"),l=(new IncreaseIntensityControl(o,map),document.createElement("div"));new DecreaseIntensityControl(l,map);o.index=1,l.index=1,map.controls[google.maps.ControlPosition.LEFT_TOP].push(o),map.controls[google.maps.ControlPosition.LEFT_TOP].push(l);var r=new google.maps.visualization.HeatmapLayer({data:heatMapData,radius:heatmapRadius,maxIntensity:heatmapIntensity});if(r.setMap(map),null!=(saveData=JSON.parse(localStorage.getItem("saveData")))){for(var s,i,d,c,p,m=0,g=0;g<saveData.length;g++)(d=saveData[g].amp)>m&&(m=d);for(g=0;g<saveData.length;g++){s=saveData[g].lat,i=saveData[g].lng,d=saveData[g].amp,c=saveData[g].head,p=saveData[g].freq,heatMapData.push({location:new google.maps.LatLng(s,i),weight:d/m,amp:d,freq:p});var u=heatMapData.length-1;if(0==isNaN(c)&&null!=c){var y=[heatMapData[u].location,google.maps.geometry.spherical.computeOffset(heatMapData[u].location,HEADING_LINE_DISTANCE,c)],f=new google.maps.Polyline({path:y,geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2});f.setMap(map)}else f=[];headingLineData.push(f)}reloadHeatmapData()}else saveData=[];if(null!=(antMapData=JSON.parse(localStorage.getItem("antMapData"))))for(g=0;g<antMapData.length;g++){var h={lat:antMapData[g].lat,lng:antMapData[g].lng},D=new google.maps.Marker({position:h,map:map});D.addListener("rightclick",function(e){dropdownMenus=document.querySelectorAll(".dropdown-trigger");for(var t=0;t<dropdownMenus.length;t++)M.Dropdown.getInstance(dropdownMenus[t]).close();M.Dropdown.getInstance(document.getElementById("rightClickTrigger-ant")).open();var a=document.getElementById("rightClickMenu-ant");a.style.left=`${e.tb.clientX}px`,a.style.top=`${e.tb.clientY}px`,lastLat=e.latLng.lat(),lastLng=e.latLng.lng(),lastMarker=D})}else antMapData=[];window.heatmap=r,window.heatMapData=heatMapData}function reloadHeatmapData(){DEBUG_MODE&&console.log(`${Date.now()}: reloadHeatmapData()`),"undefined"!=typeof heatmap&&heatmap.setOptions({data:heatMapData})}function IncreaseIntensityControl(e,t){DEBUG_MODE&&console.log(`${Date.now()}: IncreaseIntensityControl()`);var a=document.createElement("div");a.style.backgroundColor="#fff",a.style.border="2px solid #fff",a.style.borderRadius="3px",a.style.boxShadow="0 2px 6px rgba(0,0,0,.3)",a.style.cursor="pointer",a.style.marginLeft="10px",a.style.marginTop="10px",a.style.marginBottom="5px",a.style.textAlign="center",a.title="Increase Intensity",e.appendChild(a);var n=document.createElement("div");n.style.color="rgba(1,1,1,0.6)",n.style.fontFamily="Roboto,Arial,sans-serif",n.style.fontSize="3rem",n.style.fontWeight="400",n.style.width="40px",n.style.height="40px",n.innerHTML='<i class="material-icons" style="font-Size: 43px;">expand_less</i>',a.appendChild(n),a.addEventListener("click",function(){heatmapIntensity=Math.max(heatmapIntensity-1,2),DEBUG_MODE&&console.log(`${Date.now()}: heatmapIntensity - ${heatmapIntensity}`),heatmap.setOptions({maxIntensity:heatmapIntensity}),localStorage.setItem("heatmapIntensity",JSON.stringify(heatmapIntensity))})}function DecreaseIntensityControl(e,t){DEBUG_MODE&&console.log(`${Date.now()}: DecreaseIntensityControl()`);var a=document.createElement("div");a.style.backgroundColor="#fff",a.style.border="2px solid #fff",a.style.borderRadius="3px",a.style.boxShadow="0 2px 6px rgba(0,0,0,.3)",a.style.cursor="pointer",a.style.marginLeft="10px",a.style.textAlign="center",a.title="Decrease Intensity",e.appendChild(a);var n=document.createElement("div");n.style.color="rgba(1,1,1,0.6)",n.style.fontFamily="Roboto,Arial,sans-serif",n.style.fontSize="3rem",n.style.fontWeight="400",n.style.width="40px",n.style.height="40px",n.innerHTML='<i class="material-icons" style="font-Size: 43px;">expand_more</i>',a.appendChild(n),a.addEventListener("click",function(){heatmapIntensity=Math.min(heatmapIntensity+1,50),DEBUG_MODE&&console.log(`${Date.now()}: heatmapIntensity - ${heatmapIntensity}`),heatmap.setOptions({maxIntensity:heatmapIntensity}),localStorage.setItem("heatmapIntensity",JSON.stringify(heatmapIntensity))})}function IncreaseRadiusControl(e,t){DEBUG_MODE&&console.log(`${Date.now()}: IncreaseRadiusControl()`);var a=document.createElement("div");a.style.backgroundColor="#fff",a.style.border="2px solid #fff",a.style.borderRadius="3px",a.style.boxShadow="0 2px 6px rgba(0,0,0,.3)",a.style.cursor="pointer",a.style.marginLeft="10px",a.style.marginBottom="5px",a.style.textAlign="center",a.title="Increase Radius",e.appendChild(a);var n=document.createElement("div");n.style.color="rgba(1,1,1,0.6)",n.style.fontFamily="Roboto,Arial,sans-serif",n.style.fontSize="30px",n.style.fontWeight="400",n.style.width="40px",n.style.height="40px",n.innerHTML="▲",a.appendChild(n),a.addEventListener("click",function(){heatmapRadius*=1.1,heatmap.setOptions({radius:heatmapRadius}),localStorage.setItem("heatmapRadius",JSON.stringify(heatmapRadius))})}function DecreaseRadiusControl(e,t){DEBUG_MODE&&console.log(`${Date.now()}: DecreaseRadiusControl()`);var a=document.createElement("div");a.style.backgroundColor="#fff",a.style.border="2px solid #fff",a.style.borderRadius="3px",a.style.boxShadow="0 2px 6px rgba(0,0,0,.3)",a.style.cursor="pointer",a.style.marginLeft="10px",a.style.textAlign="center",a.title="Decrease Radius",e.appendChild(a);var n=document.createElement("div");n.style.color="rgba(1,1,1,0.6)",n.style.fontFamily="Roboto,Arial,sans-serif",n.style.fontSize="30px",n.style.fontWeight="400",n.style.width="40px",n.style.height="40px",n.innerHTML="▼",a.appendChild(n),a.addEventListener("click",function(){heatmapRadius*=.9,heatmap.setOptions({radius:heatmapRadius}),localStorage.setItem("heatmapRadius",JSON.stringify(heatmapRadius))})}function startGPSLoop(){isFollowGps&&navigator.geolocation.getCurrentPosition(function(e){var t=e.coords.latitude,a=e.coords.longitude;if(null==t)return console.log(e.coords),isFollowGps=!1,document.getElementById("gpsBtn").innerHTML='<i class="large material-icons">gps_off</i>',void M.toast({html:"GPS Not Available Anymore!"});lastLat=t,lastLng=a,lastLoc={lat:t,lng:a},forceGPS=!0,map.setOptions({center:lastLoc}),forceGPS=!1,setTimeout(function(){startGPSLoop()},500)})}function updateRFList(){var e=document.getElementById("curRF");e.innerHTML="";for(var t=0;t<heatMapData.length;t++){var a;try{a=parseInt(google.maps.geometry.spherical.computeHeading(headingLineData[t].getPath().i[0],headingLineData[t].getPath().i[1]).toFixed())}catch(e){a="N/A"}e.innerHTML+=`<a rfid="${t}" href="#!" class="collection-item">Measurement #${t}</br>\n                                                                           Latitude: ${heatMapData[t].location.lat()}</br>\n                                                                           Longitude: ${heatMapData[t].location.lng()}</br>\n                                                                           Frequency (Mhz): ${heatMapData[t].freq}</br>\n                                                                           Amplitude: ${heatMapData[t].amp-100}</br>\n                                                                           Heading: ${a}</a>`}localStorage.setItem("saveData",JSON.stringify(saveData))}function addRFtoMap(){if(DEBUG_MODE&&console.log(`${Date.now()}: addRFtoMap()`),lat=parseFloat(document.getElementById("form-rf-lat").value),lng=parseFloat(document.getElementById("form-rf-lng").value),""==document.getElementById("form-rf-amp").value)return M.toast({html:"Amplitude Required!"}),void clearAddRFForm();if(amp=parseFloat(document.getElementById("form-rf-amp").value)+100,isNaN(amp))return M.toast({html:"Amplitude Must Be a Number!"}),void clearAddRFForm();if(amp<=0)return M.toast({html:"Amplitude Must Be Greater Than -100!"}),void clearAddRFForm();if(head=parseFloat(document.getElementById("form-rf-head").value),""!=document.getElementById("form-rf-head").value&&isNaN(head))return M.toast({html:"Heading Must Be a Number!"}),void clearAddRFForm();for(var e=amp,t=0;t<heatMapData.length;t++)ampTemp=heatMapData[t].amp,ampTemp>e&&(e=ampTemp);freq=parseFloat(document.getElementById("form-rf-freq").value),heatMapData.push({location:new google.maps.LatLng(lat,lng),weight:amp/e,amp:amp,freq:freq});var a=heatMapData.length-1;if(reloadHeatmapData(),0==isNaN(head)){var n=[heatMapData[a].location,google.maps.geometry.spherical.computeOffset(heatMapData[a].location,HEADING_LINE_DISTANCE,head)],o=new google.maps.Polyline({path:n,geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2});o.setMap(map)}else o=[];headingLineData.push(o),saveData.push({lat:lat,lng:lng,amp:amp,head:head,freq:freq}),localStorage.setItem("saveData",JSON.stringify(saveData)),clearAddRFForm()}function addAntToMap(){DEBUG_MODE&&console.log(`${Date.now()}: addAntToMap()`),lat=parseFloat(document.getElementById("form-ant-lat").value),lng=parseFloat(document.getElementById("form-ant-lng").value);var e={lat:lat,lng:lng};antMapData.push(e);var t=new google.maps.Marker({position:e,map:map});t.addListener("rightclick",function(e){dropdownMenus=document.querySelectorAll(".dropdown-trigger");for(var a=0;a<dropdownMenus.length;a++)M.Dropdown.getInstance(dropdownMenus[a]).close();M.Dropdown.getInstance(document.getElementById("rightClickTrigger-ant")).open();var n=document.getElementById("rightClickMenu-ant");n.style.left=`${e.tb.clientX}px`,n.style.top=`${e.tb.clientY}px`,lastLat=e.latLng.lat(),lastLng=e.latLng.lng(),lastMarker=t}),localStorage.setItem("antMapData",JSON.stringify(antMapData)),clearAddAntForm()}function clearAddRFForm(){DEBUG_MODE&&console.log(`${Date.now()}: clearAddRFForm()`),setTimeout(function(){document.getElementById("form-rf-lat").value="",document.getElementById("form-rf-lng").value="",document.getElementById("form-rf-amp").value="",document.getElementById("form-rf-head").value=""},200)}function clearAddAntForm(){DEBUG_MODE&&console.log(`${Date.now()}: clearAddAntForm()`),setTimeout(function(){document.getElementById("form-ant-lat").value="",document.getElementById("form-ant-lng").value=""},200)}function clearAllData(){DEBUG_MODE&&console.log(`${Date.now()}: clearAllData()`);for(var e=heatMapData.length;e>=0;e--){heatMapData.splice(e,1);try{headingLineData[e].setMap(null)}catch(e){}headingLineData.splice(e,1),saveData.splice(e,1),reloadHeatmapData()}updateRFList()}function saveVariable(e,t){DEBUG_MODE&&console.log(`${Date.now()}: saveVariable()`),e=JSON.stringify(e);var a=new Blob([e],{type:"text/plain;charset=utf-8"});saveAs(a,t)}!function(){if(DEBUG_MODE&&console.log(`${Date.now()}: redirectHttpToHttps()`),"http:"===window.location.protocol&&"keeptrack.space"===window.location.hostname){var e="https://"+(window.location.hostname+window.location.pathname+window.location.search);window.location=e}}(),function(){function e(e){if(window.FileReader){var t=new FileReader;t.onload=function(e){if(2===e.target.readyState)if(e.target.error)console.log("error");else{var t,a,n,o;clearAllData(),saveData=JSON.parse(e.target.result);for(var l=0,r=0;r<saveData.length;r++)(n=saveData[r].amp)>l&&(l=n);for(r=0;r<saveData.length;r++){t=saveData[r].lat,a=saveData[r].lng,n=saveData[r].amp,o=saveData[r].head,heatMapData.push({location:new google.maps.LatLng(t,a),weight:n/l,amp:n,freq:void 0});var s=heatMapData.length-1;if(0==isNaN(o)&&null!=o){var i=[heatMapData[s].location,google.maps.geometry.spherical.computeOffset(heatMapData[s].location,HEADING_LINE_DISTANCE,o)],d=new google.maps.Polyline({path:i,geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2});d.setMap(map)}else d=[];headingLineData.push(d)}reloadHeatmapData(),localStorage.setItem("saveData",JSON.stringify(saveData))}},t.readAsText(e.target.files[0])}}DEBUG_MODE&&console.log(`${Date.now()}: listenerInit()`),document.getElementById("addRFrmb").addEventListener("click",function(){var e=M.Modal.getInstance(document.getElementById("modal-rf"));document.getElementById("form-rf-lat").value=lastLat,document.getElementById("form-rf-lng").value=lastLng,M.updateTextFields(),e.open()}),document.getElementById("addAntrmb").addEventListener("click",function(){var e=M.Modal.getInstance(document.getElementById("modal-ant"));document.getElementById("form-ant-lat").value=lastLat,document.getElementById("form-ant-lng").value=lastLng,M.updateTextFields(),e.open()}),document.getElementById("delAntrmb").addEventListener("click",function(){lastMarker.setMap(null)}),document.getElementById("deleteBtn").addEventListener("click",function(){updateRFList()}),document.getElementById("gpsBtn").addEventListener("click",function(){1==isFollowGps?(console.log("gpsBtn"),isFollowGps=!1,document.getElementById("gpsBtn").innerHTML='<i class="large material-icons">gps_off</i>',M.FloatingActionButton.getInstance(document.getElementById("mainBtn")).close()):(isFollowGps=!0,startGPSLoop(),document.getElementById("gpsBtn").innerHTML='<i class="large material-icons">gps_fixed</i>',M.FloatingActionButton.getInstance(document.getElementById("mainBtn")).close())}),document.getElementById("addBtn").addEventListener("click",function(){isFollowGps&&(document.getElementById("form-rf-lat").value=lastLat,document.getElementById("form-rf-lng").value=lastLng,M.updateTextFields())}),document.getElementById("saveBtn").addEventListener("click",function(){saveVariable(saveData,"rf-heatmap.json")}),document.getElementById("loadBtn").addEventListener("click",function(t){document.getElementById("file-input").click(),document.getElementById("file-input").addEventListener("change",e,!1)}),document.getElementById("curRF").addEventListener("click",function(e){var t=parseInt(e.target.getAttribute("rfid"));heatMapData.splice(t,1);try{headingLineData[t].setMap(null)}catch(e){}headingLineData.splice(t,1),saveData.splice(t,1),reloadHeatmapData(),updateRFList()})}();